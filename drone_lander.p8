pico-8 cartridge // http://www.pico-8.com
version 23
__lua__
--drone lander
g=0.3--gravity

explosions={}

function lerp(st,fi,f)
	return mid(st,st*(1-f)+fi*f,fi)
end

function make_drone(x,y)
	local drone={
		x=x,y=y,
		timer=0,
		acc=3,
		vx=0,vy=0,
		maxv=3,
		flipx=false,
		alive=true,
		battery={
			tick=0,
			max_charge=6,
			charge=6,
			fill=function(b)
				b.charge=b.max_charge
			end,
			is_empty=function(b)
				return b.charge==0
			end,
			deplete=function(b)
				if not b:is_empty() then
					b.tick+=1
					if b.tick>100 then
						b.charge-=1
						b.tick=0						
					end
				end
			end
		}
	}
	return drone
end

function _init()
	drone=make_drone(6*8,6*8)
	drone.battery:fill()
end

function _update()
	local dx,dy,fh=0,0,drone.flipx
	local vx,vy=drone.vx,drone.vy

	local flying=drone.y<11*8 and 
		not drone.battery:is_empty()
	if (flying) drone.battery:deplete()
	
	if (btn(2)) dy-=drone.acc
	if (btn(3)) dy+=drone.acc*0.6--not too steep

	if flying then
		drone.timer+=1
		if (drone.timer>200)	drone.timer=0
	end
		
	if (btn(0)) dx-=drone.acc fh=false
	if (btn(1)) dx+=drone.acc fh=true

	--smoothen mv
	vy=g+lerp(vy,vy+dy,0.2)
	vx=lerp(vx,vx+dx,0.2)

	vx*=0.95--friction

	if (drone.battery:is_empty()) then
		drone.vy+=g
	else
		drone.vx=abs(vx)<=drone.maxv and vx or sgn(vx)*drone.maxv
		drone.flipx=fh
		if (btn(2) or btn(3)) then
			drone.vy=vy>=-drone.maxv and vy or -drone.maxv
		else
			drone.vy=lerp(drone.vy,0,0.1)	
		end
	end

	drone.x=mid(4,drone.x+drone.vx,124)
	if (drone.x==4 or drone.x==124) drone.vx=0

	drone.y=mid(5,drone.y+drone.vy,11*8)
	
	--oscillate if flying
	if drone.y>=11*8 then
		if (drone.vy>3) drone.alive=false
		drone.vx,drone.vy=0,0
	elseif flying then
		drone.y+=0.3*sin(0.01*drone.timer)
	end
end

function _draw()
	cls(12)
	
	map(0,0,0,0,16,16)
	
	palt(0,false)
	palt(11,true)
	--battery level
	rectfill(122,2,125,8,5)
	rectfill(122,2+(6-drone.battery.charge),125,8,10)
	spr(9,120,1)
	pal()
	
				
	print("d.b:"..drone.battery.charge)	
	spr(drone.timer%2+1,drone.x-4,drone.y,1,1,drone.flipx)
end
__gfx__
000000005655056566660666565505656666066600000000000000000000000000000000bb0000bb000000000000000000000000000000000000000000000000
000000000500005005000050050000500500005000000000000000000000000000000000b00bb00b000000000000000000000000000000000000000000000000
007007000060650000666500006065000066650000000000000000000000000000000000b0bbbb0b000000000000000000000000000000000000000000000000
000770000666685006666750066668500666675000000000000000000000000000000000b0bbbb0b000000000000000000000000000000000000000000000000
000770000666665006666650063366500633665000000000000000000000000000000000b0bbbb0b000000000000000000000000000000000000000000000000
007007006066560560665605606656056066560500000000000000000000000000000000b0bbbb0b000000000000000000000000000000000000000000000000
000000006050060560500605050000600500006000000000000000000000000000000000b0bbbb0b000000000000000000000000000000000000000000000000
000000000650600506506005000000000000000000000000000000000000000000000000b000000b000000000000000000000000000000000000000000000000
00000000000550000000000000000000000000000000000000000000000000000000000033333333444444446666666600000000000000000000000000000000
00000000009449000000000000000000000000000000000000000000000000000000000043443434444444946666666600000000000000000000000000000000
00000000094444900000000000000000000000000000000000000000000000000000000044444444494444444444444400000000000000000000000000000000
00000000455555540000000000000000000000000000000000000000000000000000000044494444444444445555555500000000000000000000000000000000
00000000495495940000000000000000000000000000000000000000000000000000000044444494444444444444449400000000000000000000000000000000
00000000499999940000000000000000000000000000000000000000000000000000000049444444444494444944944400000000000000000000000000000000
00000000495995940000000000000000000000000000000000000000000000000000000044444494494444444444444400000000000000000000000000000000
00000000445445440000000000000000000000000000000000000000000000000000000044444444444444444444494400000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000bb0000bb0000bb00000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000bb00bbbb00bb000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000003b00bb00b30000000000000007760067700000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb3b303bb303b3bb0000000000077776677770000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000bb33bb33bb33bb00000000000077777777770007777777700000000
000000000000000000000000000000000000000000000000000000000000000000000000003bb3b33b3bb3000000000006667777777766607777777700000000
0000000000000000000000000000000000000000000000000000000000000000000000000bb33b3bb3b33bb00000000067776777777677767777777700000000
000000000000000000000000000000000000000000000000000000000000000000000000bb3bbbb33bbbb3bb0000000077777777777777777777777700000000
000000000000000000000000000000000000000000000000000000000000000000000000b3bb3bb3000000000000000077777777777777770000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb3b3b3b000000000000000067776777777677760000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000033b3bbb3000000000000000006667777777766600000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb3b3b3b000000000000000000077777777770000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb3333bb000000000000000000077776677770000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000033b3b3bb000000000000000000007760067700000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000bb3bbb3b000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000b3bbbbb3000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000002c2c2c2d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000003c3c3c3d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000002c2c2d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000003c3d3d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000292a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000002939392a000000292a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
191919191919191b1b191919191b1b1900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a1a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
