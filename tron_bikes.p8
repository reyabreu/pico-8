pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function make_bike(idx,x,y,bdir)
	local bike={}
	bike.x=x
	bike.y=y
	bike.dir=bdir or 0 --up (anticlockwise)
	bike.speed=1
	bike.idx=idx --0,1
	bike.visible=true
	bike.col=idx==0 and 1 or 9 
	bike.trail={}
	bike.finished=false
	bike.done=false
	bike.btnreleased=true
	bike.cor=nil
	return bike
end

function _init()
	blue=make_bike(0,10,60,0)
	yellow=make_bike(1,110,60,0)
end

function mv_left(bike)
	bike.dir+=1
	if (bike.dir>3) bike.dir=0
end

function mv_right(bike)
	bike.dir-=1
	if (bike.dir<0) bike.dir=3
end

function update_bike_pos(bike)
	add(bike.trail,{x=bike.x,y=bike.y})
	if (bike.dir==0) bike.y-=bike.speed
	if (bike.dir==1) bike.x-=bike.speed
	if (bike.dir==2) bike.y+=bike.speed
	if (bike.dir==3) bike.x+=bike.speed

	bike.finished=(bike.x<1 or bike.x>128)	or (bike.y<1 or bike.y>128)
	bike.visible=not bike.finished
end

function update_bike(bike,left,right)
 if not bike.finished then
	 local btnpressed=left or right
		if (bike.btnreleased and btnpressed) then
			 if (right) mv_right(blue)
			 if (left) mv_left(blue)
			 sfx(0)	
			end
		update_bike_pos(bike)
		bike.btnreleased=not btnpressed
	end	
end

function _update()
	update_bike(blue,btn(0),btn(1))
end

function draw_trail(bike)
	for v in all(bike.trail) do
		pset(v.x,v.y,bike.col)
	end
end

function draw_bike(bike)
	local idx,flip_h,flip_v=1+16*bike.idx,false,false
	if (bike.dir%2>0) idx+=1
	if (bike.dir==2) flip_v=true
	if (bike.dir==3) flip_h=true
	spr(idx,bike.x-4,bike.y-4,1.0,1.0,flip_h,flip_v)	
end

function lerp(start,finish,factor)
	return mid(start,start*(1-factor)+finish*factor,finish)
end

function draw_explosion(x,y)
	local r=1
	sfx(1)
	for i=1,30 do
		r=lerp(r,8,0.1)
		circfill(x,y,r,7)
		if (r>6) circfill(x,y,6,9)
		if (r>2) circfill(x,y,2,8)
		yield()
	end
end

function _draw()
 cls()
 draw_trail(blue)
 draw_trail(yellow) 

 if (blue.visible) draw_bike(blue)
 if (yellow.visible) draw_bike(yellow)

 if blue.finished then
  local function wrap()
  	draw_explosion(blue.x,blue.y)
  end
  if not blue.done then 
   if (blue.cor==nil)	blue.cor=cocreate(wrap)
   if blue.cor and costatus(blue.cor)~='dead' then
   	coresume(blue.cor)
   else
    blue.cor=nil
   	blue.done=true
   end
  end  
 end
 if (yellow.finished) draw_explosion(yellow) 
end


__gfx__
000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000c0c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070000ccccc000c00cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000c0c000ccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000c0c00c0c000dc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070000cc0cc00ccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000ccdcc000c00cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000a0a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000aaaaa000a00aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000a0a000aaaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000a0a00a0a0009a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000aa0aa00aaaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000aa9aa000a00aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000aaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00020000271602614023130201301d1301a1301713014130121300f1300c120081200511002110001000e1000d1000b1000910008100061000410002100011000010000100061000610006100000000000000000
00030000266502c650316503664035640336302d630256201d62017520145200f5200d5200b5200a5300753007530065300554005150061500715000000000000000000000000000000000000000000000000000
